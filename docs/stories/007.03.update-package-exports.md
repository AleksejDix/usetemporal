# Story 007.03: Update Package Exports Structure for Optimal Tree-Shaking

## Status
Proposed

## Epic
007 - Tree-Shaking Architecture Refactor

## Priority
High

## Story Points
5

## Story
**As a** developer using bundlers (Webpack, Rollup, Vite),
**I want** the package exports configured for optimal tree-shaking,
**So that** my bundler can eliminate unused code and my bundle size reflects only what I import.

## Story Context

**Existing System Integration:**
- Depends on: Story 007.01 (Remove Global Unit Registry), Story 007.02 (Extract Calendar)
- Refactors: package.json exports field, TypeScript configuration, build process
- Technology: ESM package exports, subpath exports
- Follows pattern: Modern npm package best practices
- Touch points: package.json, tsconfig.json, vite.config.ts, build output

**Problem Being Solved:**
The package needs properly configured exports to enable bundler tree-shaking. After removing global registry side effects (Story 007.01) and extracting calendar (Story 007.02), the package.json exports field must be updated to expose granular entry points that bundlers can optimize.

**Current State:**
```json
{
  "sideEffects": false,  // ← CORRECT after Story 007.01
  "exports": {
    ".": "./dist/index.js",
    "./composables": "./dist/composables/index.js",
    "./native": "./dist/native.js",
    // ... adapters
  }
}
```

**Target State:**
```json
{
  "sideEffects": false,
  "exports": {
    ".": "./dist/index.js",              // Full API (Level 3)
    "./operations": "./dist/operations/index.js",  // Pure functions (Level 1)
    "./calendar": "./dist/calendar/index.js",      // Optional calendar
    "./composables": "./dist/composables/index.js",
    "./native": "./dist/native.js",
    // ... adapters
  }
}
```

## Acceptance Criteria

**Export Configuration:**
1. Add `./operations` subpath export for pure operation functions
2. Add `./calendar` subpath export for calendar utilities (from Story 007.02)
3. Keep existing adapter exports (./native, ./luxon, ./date-fns, ./temporal)
4. Keep existing composables export
5. Main export (`.`) includes convenience API but tree-shakes properly

**Tree-Shaking Validation:**
6. `sideEffects: false` declaration is accurate (verified via audit)
7. Importing only `./operations` does NOT pull in composables or calendar
8. Importing only `./calendar` does NOT pull in operations
9. Unused operations within imports result in 0KB in bundle

**Build Process:**
10. TypeScript build generates correct .d.ts files for all subpath exports
11. Build output structure matches export paths
12. Source maps work correctly for all entry points

**Quality Requirements:**
13. All 722 tests pass after export changes
14. TypeScript compiles with zero errors
15. Package publishes correctly (dry-run test)

## Tasks / Subtasks

### Phase 1: Dependencies and Analysis
- [ ] **Verify Story 007.01 complete** - Global registry removed
- [ ] **Verify Story 007.02 complete** - Calendar extracted
- [ ] Create branch or continue on `refactor/tree-shaking-007-03`
- [ ] **Audit current sideEffects declaration** (AC#6)
  ```bash
  # Check for side effects in code
  git grep "global\." src/
  git grep "window\." src/
  git grep "document\." src/
  # Should find nothing - all code is pure
  ```
- [ ] Document current bundle sizes per entry point

### Phase 2: Update package.json Exports

#### 2.1 Add new subpath exports (AC#1, #2)
- [ ] **Add ./operations export**
```json
"./operations": {
  "types": "./dist/operations/index.d.ts",
  "import": "./dist/operations/index.js"
}
```

- [ ] **Add ./calendar export** (from Story 007.02)
```json
"./calendar": {
  "types": "./dist/calendar/index.d.ts",
  "import": "./dist/calendar/index.js"
}
```

#### 2.2 Update main export (AC#5)
- [ ] **Review src/index.ts** - what does it export?
  - Should export convenience API (createTemporal, usePeriod)
  - Should NOT auto-import operations or calendar
  - Tree-shaking depends on what's actually used
- [ ] **Ensure main export remains backward compatible** (for users who don't migrate yet)

#### 2.3 Verify existing exports (AC#3, #4)
- [ ] **Keep adapter exports unchanged**
  - `./native`, `./luxon`, `./date-fns`, `./date-fns-tz`, `./temporal`
- [ ] **Keep composables export**
  - `./composables`
- [ ] **Keep types export**
  - `./types`

#### 2.4 Complete package.json exports (AC#11)
```json
{
  "name": "@allystudio/usetemporal",
  "version": "2.0.0",
  "type": "module",
  "sideEffects": false,
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    },
    "./operations": {
      "types": "./dist/operations/index.d.ts",
      "import": "./dist/operations/index.js"
    },
    "./calendar": {
      "types": "./dist/calendar/index.d.ts",
      "import": "./dist/calendar/index.js"
    },
    "./composables": {
      "types": "./dist/composables/index.d.ts",
      "import": "./dist/composables/index.js"
    },
    "./types": {
      "types": "./dist/types.d.ts"
    },
    "./native": {
      "types": "./dist/native.d.ts",
      "import": "./dist/native.js"
    },
    "./temporal": {
      "types": "./dist/temporal.d.ts",
      "import": "./dist/temporal.js"
    },
    "./luxon": {
      "types": "./dist/luxon.d.ts",
      "import": "./dist/luxon.js"
    },
    "./date-fns": {
      "types": "./dist/date-fns.d.ts",
      "import": "./dist/date-fns.js"
    },
    "./date-fns-tz": {
      "types": "./dist/date-fns-tz.d.ts",
      "import": "./dist/date-fns-tz.js"
    }
  },
  "main": "./dist/index.js",
  "module": "./dist/index.js",
  "types": "./dist/index.d.ts"
}
```

### Phase 3: Update Build Configuration

#### 3.1 Review TypeScript configuration
- [ ] **Check tsconfig.json** - ensure it generates types for all exports
- [ ] **Verify declaration maps** work for debugging
- [ ] Test that TypeScript can resolve all subpath imports

#### 3.2 Update build process (if needed)
- [ ] **Check vite.config.ts** - ensure it builds all entry points
- [ ] **Verify build output structure** (AC#11)
```
dist/
├── index.js
├── index.d.ts
├── operations/
│   ├── index.js
│   └── index.d.ts
├── calendar/
│   ├── index.js
│   └── index.d.ts
├── composables/
│   ├── index.js
│   └── index.d.ts
├── native.js
├── native.d.ts
└── ... (other adapters)
```

- [ ] **Test build** with `npm run build`
- [ ] **Verify all .d.ts files generated** (AC#10)
- [ ] **Verify source maps generated** (AC#12)

### Phase 4: Create Export Index Files (if needed)

#### 4.1 operations/index.ts (if doesn't exist)
- [ ] **Create or verify operations/index.ts**
```typescript
/**
 * Pure operation functions - Level 1 API
 * Import from '@allystudio/usetemporal/operations'
 */
export { period } from "./period";
export { divide } from "./divide";
export { merge } from "./merge";
export { next } from "./next";
export { previous } from "./previous";
export { go } from "./go";
export { split } from "./split";
export { contains } from "./contains";
export { isSame } from "./isSame";
export { isToday, isWeekday, isWeekend } from "./utils";

// Re-export types
export type { Period, Unit, Temporal, Adapter } from "../types";
```

#### 4.2 Verify calendar/index.ts exists (from Story 007.02)
- [ ] **Verify calendar/index.ts exports**
```typescript
export { createStableMonth } from "./stableMonth";
export { createStableYear } from "./stableYear";
```

#### 4.3 Verify composables/index.ts exists
- [ ] **Check composables/index.ts**
```typescript
export { usePeriod } from "./usePeriods";
// ... other composables
```

### Phase 5: Tree-Shaking Validation

#### 5.1 Test isolated imports (AC#7, #8)
- [ ] **Test 1: Operations only**
```bash
# Create test file
cat > test-operations.js << 'EOF'
import { period } from '@allystudio/usetemporal/operations';
import { createNativeAdapter } from '@allystudio/usetemporal/native';
const adapter = createNativeAdapter();
const p = period(adapter, new Date(), 'month');
console.log(p);
EOF

# Build and measure
npm run build
npx rollup test-operations.js --format esm -o dist/test-ops.js
gzip -c dist/test-ops.js | wc -c  # Should be ≤7KB
cat dist/test-ops.js | grep -i "usePeriod"  # Should be empty (no composables)
cat dist/test-ops.js | grep -i "stableMonth"  # Should be empty (no calendar)
```

- [ ] **Test 2: Calendar only**
```bash
cat > test-calendar.js << 'EOF'
import { createStableMonth } from '@allystudio/usetemporal/calendar';
import { createNativeAdapter } from '@allystudio/usetemporal/native';
const adapter = createNativeAdapter();
const stable = createStableMonth(adapter, new Date(), 1);
console.log(stable);
EOF

npx rollup test-calendar.js --format esm -o dist/test-cal.js
gzip -c dist/test-cal.js | wc -c  # Should be ≤10KB
cat dist/test-cal.js | grep -i "divide\|merge\|split"  # Should be minimal
```

- [ ] **Test 3: Full import (backward compatibility)**
```bash
cat > test-full.js << 'EOF'
import { createTemporal, usePeriod } from '@allystudio/usetemporal';
import { nativeAdapter } from '@allystudio/usetemporal/native';
const temporal = createTemporal({ adapter: nativeAdapter, date: new Date() });
const month = usePeriod(temporal, 'month');
console.log(month);
EOF

npx rollup test-full.js --format esm -o dist/test-full.js
gzip -c dist/test-full.js | wc -c  # Document size
```

#### 5.2 Test unused operations excluded (AC#9)
- [ ] **Import only period, verify merge excluded**
```bash
cat > test-single-op.js << 'EOF'
import { period } from '@allystudio/usetemporal/operations';
export { period };
EOF

npx rollup test-single-op.js --format esm -o dist/test-single.js
cat dist/test-single.js | grep -i "merge"  # Should be empty
cat dist/test-single.js | grep -i "divide"  # Should be empty
```

#### 5.3 Visualize bundle composition
- [ ] **Use rollup-plugin-visualizer**
```bash
npm install -D rollup-plugin-visualizer
# Add to rollup config temporarily
npx rollup test-operations.js --format esm --plugin visualizer -o dist/test.js
open stats.html  # Visual bundle analysis
```

### Phase 6: Package Publishing Test

#### 6.1 Dry-run publish (AC#15)
- [ ] **Test package locally**
```bash
npm pack
# Creates @allystudio-usetemporal-2.0.0.tgz

# Test in separate directory
mkdir /tmp/test-package
cd /tmp/test-package
npm init -y
npm install /path/to/pickle/packages/usetemporal/@allystudio-usetemporal-2.0.0.tgz

# Test imports
node --input-type=module -e "import { period } from '@allystudio/usetemporal/operations'; console.log('✓ operations')"
node --input-type=module -e "import { createStableMonth } from '@allystudio/usetemporal/calendar'; console.log('✓ calendar')"
node --input-type=module -e "import { createNativeAdapter } from '@allystudio/usetemporal/native'; console.log('✓ native')"
```

- [ ] **Verify TypeScript imports work**
```typescript
// test.ts
import { period } from '@allystudio/usetemporal/operations';
import { createStableMonth } from '@allystudio/usetemporal/calendar';
import type { Period, Adapter } from '@allystudio/usetemporal/types';

// Should compile without errors
npx tsc test.ts --noEmit
```

#### 6.2 Test in different environments
- [ ] Test with Vite project
- [ ] Test with Next.js project (if applicable)
- [ ] Test with plain Node.js script

### Phase 7: Testing and Validation

- [ ] Run `TZ=UTC npm test` - all 722 tests pass (AC#13)
- [ ] Run `npm run type-check` - zero TypeScript errors (AC#14)
- [ ] Run `npm run build` - successful build (AC#10, #11)
- [ ] **Verify no broken imports**
```bash
git grep "from \"@allystudio/usetemporal" --include="*.ts" --include="*.tsx"
# Check all imports are valid with new exports structure
```

### Phase 8: Documentation

- [ ] **Update CHANGELOG.md** with new export paths
- [ ] **Document tree-shaking improvements**
  - Before: 30KB minimum bundle
  - After: 5-7KB minimum bundle
- [ ] **Create import guide** (save for Story 007.05)
  - Level 1: `import { period } from '@allystudio/usetemporal/operations'`
  - Level 2: `import { createTemporal } from '@allystudio/usetemporal'`
  - Level 3: `import { usePeriod } from '@allystudio/usetemporal'`
- [ ] **Document calendar as optional import**

### Phase 9: QA and Review
- [ ] Self-review all changes
- [ ] Verify backward compatibility for main export
- [ ] Check IDE autocomplete works for all exports
- [ ] Verify JSDoc appears in IDE tooltips
- [ ] Submit for QA review

## Technical Notes

### Package Exports Best Practices

**Subpath Exports Pattern:**
```json
{
  "exports": {
    ".": "./main.js",           // Default export
    "./feature": "./feature.js" // Subpath export
  }
}
```

**Benefits:**
- Explicit entry points for bundlers
- Prevents deep imports (`import from 'pkg/dist/internal'`)
- Enables better tree-shaking
- TypeScript-friendly

**Requirement:** Node.js 12.20+, all modern bundlers support it

### sideEffects Field

**Purpose:** Tells bundlers which files can be safely dropped if unused

**Values:**
- `false`: No side effects (best for tree-shaking)
- `true`: All files have side effects (worst for tree-shaking)
- `["./file.js"]`: Only specified files have side effects

**After Story 007.01:** Our package has NO side effects, so `false` is correct

### Build Output Structure

The build process must create this structure:
```
dist/
├── index.js, index.d.ts           # Main export
├── operations/
│   ├── index.js, index.d.ts       # Operations export
│   ├── period.js, period.d.ts
│   ├── divide.js, divide.d.ts
│   └── ...
├── calendar/
│   ├── index.js, index.d.ts       # Calendar export
│   ├── stableMonth.js, stableMonth.d.ts
│   └── stableYear.js, stableYear.d.ts
├── composables/
│   └── index.js, index.d.ts       # Composables export
├── native.js, native.d.ts         # Native adapter export
└── ... (other adapters)
```

Each export path in package.json must match a real file in dist/

### Tree-Shaking Validation Techniques

**1. Rollup Bundle Analysis:**
```bash
npx rollup input.js --format esm -o output.js
cat output.js  # Inspect manually
```

**2. Bundle Size Measurement:**
```bash
gzip -c output.js | wc -c  # Get gzipped size
```

**3. Visual Analysis:**
```bash
npm install -D rollup-plugin-visualizer
# Generates stats.html showing what's in the bundle
```

**4. String Search:**
```bash
cat output.js | grep "functionName"  # Should be absent if tree-shaken
```

### Expected Bundle Sizes

**Level 1 (Operations only):**
- period + divide + native adapter: **5-7KB gzipped**
- All operations + native adapter: **8-10KB gzipped**

**Level 2 (With Calendar):**
- Operations + calendar + native: **12-15KB gzipped**

**Level 3 (Full DX):**
- Everything + composables: **15-20KB gzipped**

**Current (Before Refactor):**
- Single import: **30KB gzipped** ❌

### TypeScript Module Resolution

**For subpath exports to work in TypeScript:**

**tsconfig.json:**
```json
{
  "compilerOptions": {
    "moduleResolution": "bundler",  // or "node16"
    "resolveJsonModule": true
  }
}
```

**User projects must use:**
- TypeScript 4.7+ for subpath exports
- `moduleResolution: "bundler"` or `"node16"`

### Backward Compatibility Strategy

**Main export must remain functional:**
```typescript
// Old code (should still work)
import { createTemporal } from '@allystudio/usetemporal';

// New code (better tree-shaking)
import { period } from '@allystudio/usetemporal/operations';
```

Both should work after refactor, but new code tree-shakes better.

### Common Export Pitfalls

**Pitfall 1:** Circular dependencies between exports
- **Solution:** Keep exports independent

**Pitfall 2:** Export path doesn't match build output
- **Solution:** Verify dist/ structure matches exports

**Pitfall 3:** TypeScript types not exported correctly
- **Solution:** Always include `"types": "..."` in exports

**Pitfall 4:** Source maps broken
- **Solution:** Configure build tool to generate maps for all entries

## Definition of Done

- [ ] package.json includes `./operations` and `./calendar` exports
- [ ] All adapter and composable exports remain unchanged
- [ ] `sideEffects: false` is verified as accurate
- [ ] Build generates correct .d.ts files for all exports
- [ ] Build output structure matches export paths
- [ ] Tree-shaking validated: operations-only import ≤7KB gzipped
- [ ] Tree-shaking validated: unused operations excluded from bundle
- [ ] Calendar import does not pull in operations
- [ ] Operations import does not pull in calendar or composables
- [ ] npm pack test succeeds - package installs and imports work
- [ ] All 722 tests pass
- [ ] TypeScript compiles with zero errors
- [ ] Bundle size documentation updated

## Risk and Compatibility Check

**Low Risk Assessment:**
- **Primary Risk:** Export configuration errors breaking imports
- **Impact**: LOW - affects package structure, not code logic
- **Mitigation**: Comprehensive testing with npm pack, multiple environments
- **Rollback**: Git branch allows easy rollback

**Compatibility Verification:**
- [ ] Backward compatible - main export unchanged
- [ ] No database changes
- [ ] No UI component changes
- [ ] Performance impact: POSITIVE (better tree-shaking)

## Dev Notes

### Implementation Order

1. **Update package.json first**: Add new exports
2. **Create/verify index files**: operations/index.ts, calendar/index.ts
3. **Build and test**: `npm run build`, verify dist/ structure
4. **Validate tree-shaking**: Multiple test scenarios
5. **Test package**: npm pack and install locally
6. **Documentation**: Update CHANGELOG and guides

### Testing Strategy

**Build Testing:**
- Build after every change
- Verify TypeScript types generated
- Check dist/ structure

**Import Testing:**
- Test all export paths work
- Test in separate Node.js project
- Test TypeScript type resolution

**Tree-Shaking Testing:**
- Use rollup to bundle test cases
- Measure gzipped sizes
- Verify unused code excluded

### Debugging Tips

**Export path not found:**
```bash
# Check build output
ls -la dist/operations/
# Check package.json exports field
cat package.json | jq '.exports'
```

**TypeScript can't find types:**
```bash
# Check .d.ts files generated
ls -la dist/**/*.d.ts
# Check TypeScript config
cat tsconfig.json | jq '.compilerOptions.moduleResolution'
```

**Tree-shaking not working:**
```bash
# Check for side effects in code
git grep -E "global|window\." src/
# Check sideEffects field
cat package.json | jq '.sideEffects'
```

### Related Stories

- **Story 007.01**: Remove Global Unit Registry (dependency - provides side-effect-free code)
- **Story 007.02**: Extract Calendar (dependency - provides calendar export)
- **Story 007.04**: Builder API (uses these exports)
- **Story 007.05**: Documentation (documents export structure)
- **Story 007.06**: Bundle size analysis (validates export optimization)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation | Claude (BMad Master) |

## Dev Agent Record

_To be filled by development agent upon implementation_

## QA Results

_To be filled by QA reviewer_
