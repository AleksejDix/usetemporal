# Story 004.02: Implement StableMonth Unit

## Status
Completed

## Story
**As a** calendar developer,
**I want** to use a stableMonth unit that always returns 42 days (6 weeks),
**so that** my calendar grids maintain consistent height without layout shifts.

## Acceptance Criteria
1. StableMonth unit defined using core's defineUnit API
2. Divide operation returns exactly 42 days for any month
3. Days align with weekStartsOn setting from temporal instance
4. Periods include padding days from previous/next months
5. Each day is properly typed as a Period with correct metadata
6. Unit works with all core operations (next, previous, contains, etc.)
7. Comprehensive tests verify behavior across different months
8. TypeScript types properly augmented for the new unit

## Tasks / Subtasks
- [x] Define stableMonth unit (AC: 1, 8)
  - [x] Create `units/stableMonth.ts`
  - [x] Use defineUnit() from core
  - [x] Set duration to 42 days
  - [x] Augment TypeScript UnitRegistry interface
- [x] Implement custom divide logic (AC: 2, 3, 4, 5)
  - [x] Override divide behavior for stableMonth
  - [x] Calculate start padding based on weekStartsOn
  - [x] Generate exactly 42 day periods
  - [x] Include metadata for isCurrentMonth flag
- [x] Integrate with core operations (AC: 6)
  - [x] Test next() moves to next month's stable grid
  - [x] Test previous() moves to previous month's stable grid
  - [x] Test contains() works for edge days
  - [x] Verify isSame() behavior
- [x] Create comprehensive tests (AC: 7)
  - [x] Test February (4-week month)
  - [x] Test months starting on different weekdays
  - [x] Test with different weekStartsOn values
  - [x] Test year boundaries
  - [x] Test with all adapters

## Dev Notes

### Testing Standards
- Test against all standard adapters (native, date-fns, luxon)
- Include edge cases: leap years, year boundaries, different week starts
- Verify consistent 42-day output for all months

### Context
- StableMonth should behave like a regular month for most operations
- The key difference is divide() always returns 42 days
- Reference the existing workaround in `/vitepress/examples/stable-month-calendar.md`
- Consider performance implications of generating padding days

### Implementation Approach
```typescript
// Example structure
defineUnit('stableMonth', {
  duration: { days: 42 },
  validate: (adapter, date) => true,
  divide: (temporal, period) => {
    // Custom logic to generate 6-week grid
    // Must respect temporal.weekStartsOn
  }
});

// TypeScript augmentation
declare module '@usetemporal/core' {
  interface UnitRegistry {
    stableMonth: true;
  }
}
```

### Key Considerations
- Padding days should be full Period objects
- Consider adding metadata to distinguish current month days
- Ensure compatibility with calendar rendering libraries

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-25 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet

### Debug Log References
- Fixed day counting confusion (41 vs 42 days)
- Adjusted validation to check for 42 days instead of 41
- Core divide operation correctly returns 42 days as expected

### Completion Notes List
- Successfully implemented stableMonth unit that always returns 42 days
- Used defineUnit API with custom createPeriod logic
- Properly handles weekStartsOn setting from temporal instance
- Works with divide operation to return exactly 42 days (6 weeks)
- Created helper function createStableMonth for manual period creation
- All tests passing with multiple adapters

### File List
- /packages/calendar-units/src/units/stableMonth.ts (created)
- /packages/calendar-units/src/__tests__/stableMonth.test.ts (created)
- /packages/calendar-units/src/index.ts (updated)

## QA Results
All tests passing:
- Unit registration verified
- 42-day grid confirmed for all months
- weekStartsOn setting respected
- Edge cases (February, year boundaries, leap years) handled correctly
- Integration with all adapters (native, date-fns, luxon) successful
- Build successful with no TypeScript errors