# Story 010.03: Create useCalendarInteraction Composable

## Status
Draft

## Story
**As a** developer building the divide visualization,  
**I want** a headless composable that manages user interactions,  
**So that** I can handle hover, click, and keyboard events consistently across all views.

## Story Context

**Existing System Integration:**
- Integrates with: Vue 3 event system, Period types
- Technology: TypeScript, Vue 3 composables, event handling
- Follows pattern: Headless interaction management
- Touch points: Will be used by YearGridView, MonthGridView, DayDetailView

## Acceptance Criteria

**Functional Requirements:**
1. Tracks hover state for periods (with hover enter/leave)
2. Handles click events on periods
3. Implements keyboard navigation (arrow keys, enter, escape)
4. Supports focus management for accessibility
5. Provides touch event handling for mobile
6. Debounces rapid hover events

**Integration Requirements:**
7. Works with Period objects from useCalendarData
8. Emits standardized events for navigation
9. Configurable keyboard shortcuts
10. SSR-safe (no direct DOM access in setup)

**Quality Requirements:**
11. Keyboard navigation follows ARIA grid pattern
12. Touch events work on mobile devices
13. Hover states have proper cleanup
14. Performance optimized for rapid interactions

## Technical Notes

- **Integration Approach:** Event delegation pattern with composable state
- **Existing Pattern Reference:** Similar to keyboard navigation in data tables
- **Key Constraints:** Must be flexible enough for different view layouts

## Definition of Done

- [ ] Composable created in `/vitepress/.vitepress/composables/useCalendarInteraction.ts`
- [ ] TypeScript interfaces for interaction events
- [ ] Hover state tracking implementation
- [ ] Click handler with period selection
- [ ] Keyboard navigation (arrows, enter, escape)
- [ ] Focus management utilities
- [ ] Touch event support
- [ ] Event debouncing utilities
- [ ] Unit tests for all interaction types
- [ ] Accessibility testing helpers
- [ ] JSDoc documentation
- [ ] Example integration test

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Browser compatibility for keyboard events
- **Mitigation:** Use standard key codes, test across browsers
- **Rollback:** N/A - new code only

**Compatibility Verification:**
- [ ] No breaking changes (new code)
- [ ] No database changes
- [ ] No UI rendering
- [ ] Browser event API compatible

## Dev Notes

### File Structure
```
/vitepress/.vitepress/composables/useCalendarInteraction.ts
/vitepress/.vitepress/composables/__tests__/useCalendarInteraction.test.ts
```

### Interface Design

```typescript
interface InteractionState {
  hoveredPeriod: Period | null
  focusedPeriod: Period | null
  focusedIndex: number
  lastInteraction: 'mouse' | 'keyboard' | 'touch'
}

interface InteractionEvents {
  onPeriodClick?: (period: Period) => void
  onPeriodHover?: (period: Period | null) => void
  onNavigate?: (direction: 'up' | 'down' | 'left' | 'right' | 'in' | 'out') => void
  onEscape?: () => void
}

interface KeyboardConfig {
  enableArrows?: boolean
  enableWASD?: boolean
  enableVim?: boolean
  customBindings?: Record<string, string>
}

interface UseCalendarInteractionReturn {
  // State
  hoveredPeriod: Readonly<Ref<Period | null>>
  focusedPeriod: Readonly<Ref<Period | null>>
  interactionMode: ComputedRef<'mouse' | 'keyboard' | 'touch'>
  
  // Event Handlers
  handlePeriodClick(period: Period): void
  handlePeriodHover(period: Period | null): void
  handleKeyDown(event: KeyboardEvent): void
  handleTouchStart(period: Period, event: TouchEvent): void
  handleTouchEnd(period: Period, event: TouchEvent): void
  
  // Focus Management
  focusPeriod(period: Period, index: number): void
  focusNext(): void
  focusPrevious(): void
  clearFocus(): void
  
  // Grid Navigation
  navigateGrid(direction: 'up' | 'down' | 'left' | 'right', gridWidth: number): void
  
  // Utilities
  registerContainer(element: HTMLElement): void
  destroy(): void
}
```

### Implementation Approach

```typescript
export function useCalendarInteraction(
  events: InteractionEvents = {},
  config: KeyboardConfig = {}
): UseCalendarInteractionReturn {
  const state = reactive<InteractionState>({
    hoveredPeriod: null,
    focusedPeriod: null,
    focusedIndex: -1,
    lastInteraction: 'mouse'
  })
  
  // Hover debouncing
  let hoverTimeout: number | null = null
  const HOVER_DELAY = 50 // ms
  
  function handlePeriodHover(period: Period | null) {
    if (hoverTimeout) {
      clearTimeout(hoverTimeout)
    }
    
    hoverTimeout = window.setTimeout(() => {
      state.hoveredPeriod = period
      state.lastInteraction = 'mouse'
      events.onPeriodHover?.(period)
    }, HOVER_DELAY)
  }
  
  function handlePeriodClick(period: Period) {
    state.lastInteraction = 'mouse'
    events.onPeriodClick?.(period)
  }
  
  // Keyboard handling
  const keyMap: Record<string, string> = {
    ArrowUp: 'up',
    ArrowDown: 'down',
    ArrowLeft: 'left',
    ArrowRight: 'right',
    Enter: 'select',
    ' ': 'select',
    Escape: 'back',
    ...config.customBindings
  }
  
  // Add optional WASD support
  if (config.enableWASD) {
    Object.assign(keyMap, {
      w: 'up', W: 'up',
      s: 'down', S: 'down',
      a: 'left', A: 'left',
      d: 'right', D: 'right'
    })
  }
  
  // Add optional Vim support
  if (config.enableVim) {
    Object.assign(keyMap, {
      h: 'left', H: 'left',
      j: 'down', J: 'down',
      k: 'up', K: 'up',
      l: 'right', L: 'right'
    })
  }
  
  function handleKeyDown(event: KeyboardEvent) {
    const action = keyMap[event.key]
    if (!action) return
    
    event.preventDefault()
    state.lastInteraction = 'keyboard'
    
    switch (action) {
      case 'up':
      case 'down':
      case 'left':
      case 'right':
        events.onNavigate?.(action)
        break
      case 'select':
        if (state.focusedPeriod) {
          events.onPeriodClick?.(state.focusedPeriod)
        }
        break
      case 'back':
        events.onEscape?.()
        break
    }
  }
  
  // Grid navigation helper
  function navigateGrid(
    direction: 'up' | 'down' | 'left' | 'right',
    gridWidth: number
  ) {
    const currentIndex = state.focusedIndex
    let newIndex = currentIndex
    
    switch (direction) {
      case 'up':
        newIndex = Math.max(0, currentIndex - gridWidth)
        break
      case 'down':
        newIndex = currentIndex + gridWidth
        break
      case 'left':
        newIndex = Math.max(0, currentIndex - 1)
        break
      case 'right':
        newIndex = currentIndex + 1
        break
    }
    
    state.focusedIndex = newIndex
    // Component will need to map index to actual period
  }
  
  // Touch handling
  let touchStartTime = 0
  const TOUCH_THRESHOLD = 300 // ms for tap vs hold
  
  function handleTouchStart(period: Period, event: TouchEvent) {
    touchStartTime = Date.now()
    state.lastInteraction = 'touch'
  }
  
  function handleTouchEnd(period: Period, event: TouchEvent) {
    const duration = Date.now() - touchStartTime
    
    if (duration < TOUCH_THRESHOLD) {
      // Treat as click
      handlePeriodClick(period)
    } else {
      // Could implement long press behavior
    }
  }
  
  // Focus management
  function focusPeriod(period: Period, index: number) {
    state.focusedPeriod = period
    state.focusedIndex = index
    state.lastInteraction = 'keyboard'
  }
  
  function clearFocus() {
    state.focusedPeriod = null
    state.focusedIndex = -1
  }
  
  // Container registration for event delegation
  let container: HTMLElement | null = null
  
  function registerContainer(element: HTMLElement) {
    container = element
    // Could set up event listeners here if needed
  }
  
  function destroy() {
    if (hoverTimeout) {
      clearTimeout(hoverTimeout)
    }
    clearFocus()
    container = null
  }
  
  const interactionMode = computed(() => state.lastInteraction)
  
  return {
    hoveredPeriod: readonly(toRef(state, 'hoveredPeriod')),
    focusedPeriod: readonly(toRef(state, 'focusedPeriod')),
    interactionMode,
    handlePeriodClick,
    handlePeriodHover,
    handleKeyDown,
    handleTouchStart,
    handleTouchEnd,
    focusPeriod,
    focusNext: () => state.focusedIndex++,
    focusPrevious: () => state.focusedIndex--,
    clearFocus,
    navigateGrid,
    registerContainer,
    destroy
  }
}
```

### Accessibility Patterns

Following ARIA grid pattern:
- Arrow keys navigate between cells
- Enter/Space select current cell
- Escape moves up hierarchy
- Tab moves to next component
- Announce state changes

### Mobile Considerations

1. **Touch Targets**: Minimum 44x44px
2. **Gestures**: Tap to select, swipe to navigate
3. **Hover Alternative**: Show info on tap
4. **Performance**: Debounce touch moves

### Testing Approach

```typescript
// Simulate interactions
const { handleKeyDown, focusedPeriod } = useCalendarInteraction({
  onNavigate: vi.fn()
})

// Test keyboard
const event = new KeyboardEvent('keydown', { key: 'ArrowRight' })
handleKeyDown(event)
expect(events.onNavigate).toHaveBeenCalledWith('right')
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-27 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
(To be populated by dev agent)

## QA Results
(To be populated by QA agent)