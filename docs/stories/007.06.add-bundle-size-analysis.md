# Story 007.06: Add Bundle Size Analysis and CI Monitoring

## Status
Proposed

## Epic
007 - Tree-Shaking Architecture Refactor

## Priority
Medium

## Story Points
5

## Story
**As a** maintainer of useTemporal,
**I want** automated bundle size tracking and CI monitoring,
**So that** I can prevent bundle size regressions and validate tree-shaking improvements.

## Story Context

**Existing System Integration:**
- Depends on: Stories 007.01-007.05 (all refactoring complete)
- Adds: Bundle size analysis tooling, CI integration, size budgets
- Technology: rollup-plugin-visualizer, size-limit, GitHub Actions
- Follows pattern: Automated quality gates
- Touch points: CI/CD pipeline, package.json scripts, size budgets configuration

**Problem Being Solved:**
After achieving significant bundle size reductions (76% for minimal usage), we need:
1. Automated measurement of bundle sizes for each API level
2. Prevention of bundle size regressions in future PRs
3. Visualization of what's included in bundles
4. Historical tracking of bundle size over time
5. Validation that tree-shaking actually works

**Success Metrics:**
- Bundle sizes automatically measured on every PR
- CI fails if bundle exceeds size budgets
- Visual bundle analysis available for every build
- Tree-shaking effectiveness validated

## Acceptance Criteria

**Bundle Size Measurement:**
1. Create build scenarios for Level 1, Level 2, Level 3 usage
2. Measure gzipped bundle sizes for each scenario
3. Generate visual bundle analysis reports
4. Measure tree-shaking effectiveness (unused code percentage)

**Size Budgets:**
5. Define size budgets for each API level
6. Level 1 (Pure): â‰¤7KB gzipped
7. Level 2 (Builder): â‰¤12KB gzipped
8. Level 3 (Composables): â‰¤20KB gzipped
9. CI fails if budgets exceeded

**CI Integration:**
10. Bundle size analysis runs on every PR
11. PR comments show bundle size comparison (before/after)
12. Visual reports uploaded as CI artifacts
13. CI badge shows current bundle sizes

**Documentation:**
14. README badge shows bundle sizes
15. Documentation includes bundle size guidelines
16. Size budget rationale documented

## Tasks / Subtasks

### Phase 1: Setup Bundle Analysis Tools

#### 1.1 Install dependencies
- [ ] **Install bundle analysis tools**
```bash
cd packages/usetemporal
npm install -D @size-limit/preset-small-lib
npm install -D rollup-plugin-visualizer
npm install -D bundlesize
```

#### 1.2 Create test scenarios (AC#1)
- [ ] **Create test/bundle-scenarios/ directory**
```
test/bundle-scenarios/
â”œâ”€â”€ level-1-minimal.ts      # period + divide + native
â”œâ”€â”€ level-1-full.ts         # all operations + native
â”œâ”€â”€ level-2-basic.ts        # builder with few methods
â”œâ”€â”€ level-2-full.ts         # builder with many methods
â”œâ”€â”€ level-3-composables.ts  # full DX with reactivity
â””â”€â”€ calendar.ts             # calendar utilities
```

- [ ] **Create level-1-minimal.ts** (AC#2)
```typescript
// Minimal Level 1 usage - should be â‰¤7KB
import { period, divide } from '@allystudio/usetemporal/operations';
import { createNativeAdapter } from '@allystudio/usetemporal/native';

export const adapter = createNativeAdapter({ weekStartsOn: 1 });
export const month = period(adapter, new Date(), 'month');
export const weeks = divide(adapter, month, 'week');
```

- [ ] **Create level-2-basic.ts**
```typescript
// Basic Level 2 usage - should be â‰¤10KB
import { createTemporal } from '@allystudio/usetemporal';
import { createNativeAdapter } from '@allystudio/usetemporal/native';

export const temporal = createTemporal({
  adapter: createNativeAdapter(),
  weekStartsOn: 1
});

export const month = temporal.period(new Date(), 'month');
export const weeks = temporal.divide(month, 'week');
```

- [ ] **Create level-3-composables.ts**
```typescript
// Full Level 3 usage - should be â‰¤20KB
import { createTemporal, usePeriod } from '@allystudio/usetemporal';
import { createNativeAdapter } from '@allystudio/usetemporal/native';
import { ref } from '@vue/reactivity';

export const temporal = createTemporal({
  adapter: createNativeAdapter(),
  date: ref(new Date())
});

export const month = usePeriod(temporal, 'month');
```

- [ ] **Create calendar.ts**
```typescript
// Calendar usage - should add ~5KB
import { createStableMonth } from '@allystudio/usetemporal/calendar';
import { createNativeAdapter } from '@allystudio/usetemporal/native';

export const adapter = createNativeAdapter();
export const stable = createStableMonth(adapter, new Date(), 1);
```

### Phase 2: Configure size-limit

#### 2.1 Create .size-limit.js (AC#5-8)
- [ ] **Create .size-limit.js in package root**
```javascript
module.exports = [
  {
    name: "Level 1 - Minimal (period + divide)",
    path: "test/bundle-scenarios/level-1-minimal.ts",
    limit: "7 KB",
    gzip: true,
    webpack: false,
    running: false
  },
  {
    name: "Level 1 - Full Operations",
    path: "test/bundle-scenarios/level-1-full.ts",
    limit: "10 KB",
    gzip: true
  },
  {
    name: "Level 2 - Builder Basic",
    path: "test/bundle-scenarios/level-2-basic.ts",
    limit: "12 KB",
    gzip: true
  },
  {
    name: "Level 2 - Builder Full",
    path: "test/bundle-scenarios/level-2-full.ts",
    limit: "15 KB",
    gzip: true
  },
  {
    name: "Level 3 - Composables",
    path: "test/bundle-scenarios/level-3-composables.ts",
    limit: "20 KB",
    gzip: true
  },
  {
    name: "Calendar Utilities",
    path: "test/bundle-scenarios/calendar.ts",
    limit: "10 KB",
    gzip: true
  }
];
```

#### 2.2 Add size-limit scripts (AC#2)
- [ ] **Update package.json scripts**
```json
{
  "scripts": {
    "size": "size-limit",
    "size:why": "size-limit --why",
    "size:visualize": "npm run build && rollup-plugin-visualizer --open"
  }
}
```

### Phase 3: Configure rollup-plugin-visualizer

#### 3.1 Update vite.config.ts (AC#3)
- [ ] **Add visualizer plugin**
```typescript
import { defineConfig } from 'vite';
import dts from 'vite-plugin-dts';
import { visualizer } from 'rollup-plugin-visualizer';

export default defineConfig({
  build: {
    // ... existing config
  },
  plugins: [
    dts({ include: ['src'] }),
    visualizer({
      filename: './dist/stats.html',
      open: false,
      gzipSize: true,
      brotliSize: true,
      template: 'treemap' // or 'sunburst', 'network'
    })
  ]
});
```

#### 3.2 Test visualization (AC#3)
- [ ] **Run build and generate visualization**
```bash
npm run build
open dist/stats.html  # Visual bundle composition
```

### Phase 4: CI Integration (GitHub Actions)

#### 4.1 Create size-check workflow (AC#10, #11)
- [ ] **Create .github/workflows/bundle-size.yml**
```yaml
name: Bundle Size Check

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

jobs:
  size-check:
    name: Check Bundle Size
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build --workspace=@allystudio/usetemporal

      - name: Check bundle sizes
        run: npm run size --workspace=@allystudio/usetemporal

      - name: Generate size report
        if: github.event_name == 'pull_request'
        run: |
          npm run size --workspace=@allystudio/usetemporal --json > size-report.json

      - name: Comment PR with size comparison
        if: github.event_name == 'pull_request'
        uses: andresz1/size-limit-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip_step: install
```

#### 4.2 Create visualization workflow (AC#12)
- [ ] **Create .github/workflows/bundle-visualize.yml**
```yaml
name: Bundle Visualization

on:
  push:
    branches: [master, main]

jobs:
  visualize:
    name: Generate Bundle Visualization
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build with visualization
        run: npm run build --workspace=@allystudio/usetemporal

      - name: Upload visualization
        uses: actions/upload-artifact@v4
        with:
          name: bundle-visualization
          path: packages/usetemporal/dist/stats.html
          retention-days: 30

      - name: Comment visualization link
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ“Š [View bundle visualization](${artifactUrl})`
            });
```

### Phase 5: Add README Badge (AC#13, #14)

#### 5.1 Add size badges
- [ ] **Update README.md**
```markdown
# useTemporal

[![Bundle Size - Level 1](https://img.shields.io/badge/Level%201-7KB-success)](https://github.com/AleksejDix/usetemporal)
[![Bundle Size - Level 2](https://img.shields.io/badge/Level%202-12KB-success)](https://github.com/AleksejDix/usetemporal)
[![Bundle Size - Level 3](https://img.shields.io/badge/Level%203-20KB-yellow)](https://github.com/AleksejDix/usetemporal)

Revolutionary time library with unique `divide()` pattern for hierarchical time management.

## ðŸ“¦ Bundle Sizes

| API Level | Bundle Size | Use Case |
|-----------|-------------|----------|
| Level 1 (Pure) | 5-7KB | Performance-critical |
| Level 2 (Builder) | 8-12KB | Balanced approach |
| Level 3 (Composables) | 15-20KB | Full reactivity |
```

### Phase 6: Document Size Budgets (AC#15)

#### 6.1 Create BUNDLE_SIZES.md
- [ ] **Create docs/architecture/bundle-sizes.md**
```markdown
# Bundle Size Budgets and Monitoring

## Size Budgets

We enforce strict bundle size budgets to maintain useTemporal's performance promise.

### Budget Definitions

| Scenario | Budget | Rationale |
|----------|--------|-----------|
| Level 1 - Minimal | â‰¤7KB | period + divide + native adapter |
| Level 1 - Full Ops | â‰¤10KB | All operations + native adapter |
| Level 2 - Basic | â‰¤12KB | Builder with few methods |
| Level 2 - Full | â‰¤15KB | Builder with many methods |
| Level 3 - Composables | â‰¤20KB | Full DX with reactivity |
| Calendar | â‰¤10KB | Calendar utilities standalone |

### Why These Budgets?

**Level 1 (7KB):** Competitive with date-fns (2KB per function)
**Level 2 (12KB):** Smaller than Moment.js (18KB) with better DX
**Level 3 (20KB):** Includes Vue reactivity, still smaller than Luxon (24KB)

## Monitoring

### Automated Checks

- âœ… Every PR checks bundle sizes
- âœ… CI fails if budgets exceeded
- âœ… Visual reports generated
- âœ… Historical tracking

### Manual Checks

```bash
# Check all sizes
npm run size

# See detailed breakdown
npm run size:why

# Visual analysis
npm run size:visualize
```

## What to Do if Budget Exceeded

1. **Identify the cause:**
   ```bash
   npm run size:why
   ```

2. **Check what was added:**
   ```bash
   git diff HEAD~1 --stat
   ```

3. **Options:**
   - Refactor to reduce size
   - Adjust budget with team discussion
   - Split feature to separate import

4. **Update budget (if justified):**
   - Update `.size-limit.js`
   - Document reason in PR
   - Get approval from maintainers

## Historical Data

| Version | Level 1 | Level 2 | Level 3 | Notes |
|---------|---------|---------|---------|-------|
| 2.0.0   | 6KB     | 10KB    | 18KB    | Initial measurement |
| Future  | ...     | ...     | ...     | ... |
```

### Phase 7: Tree-Shaking Effectiveness Tests

#### 7.1 Create tree-shaking test script (AC#4)
- [ ] **Create test/measure-tree-shaking.js**
```javascript
#!/usr/bin/env node

/**
 * Measure tree-shaking effectiveness
 * Compares full package size vs. what's actually bundled
 */

import { rollup } from 'rollup';
import { gzipSync } from 'zlib';
import { statSync, readFileSync } from 'fs';
import { join } from 'path';

async function measureBundleSize(inputFile) {
  const bundle = await rollup({
    input: inputFile,
    external: ['@vue/reactivity']
  });

  const { output } = await bundle.generate({
    format: 'esm'
  });

  const code = output[0].code;
  const gzipped = gzipSync(code);

  return {
    raw: code.length,
    gzipped: gzipped.length
  };
}

async function analyzeTreeShaking() {
  console.log('ðŸŒ³ Tree-Shaking Effectiveness Analysis\n');

  // Full package size
  const distSize = statSync(join('dist', 'index.js')).size;
  const fullGzip = gzipSync(readFileSync(join('dist', 'index.js'))).length;

  console.log(`ðŸ“¦ Full Package: ${distSize} bytes (${fullGzip} gzipped)`);
  console.log('');

  // Measure each scenario
  const scenarios = [
    { name: 'Level 1 - Minimal', file: 'test/bundle-scenarios/level-1-minimal.ts' },
    { name: 'Level 2 - Basic', file: 'test/bundle-scenarios/level-2-basic.ts' },
    { name: 'Level 3 - Full', file: 'test/bundle-scenarios/level-3-composables.ts' },
  ];

  for (const scenario of scenarios) {
    const size = await measureBundleSize(scenario.file);
    const efficiency = ((1 - size.gzipped / fullGzip) * 100).toFixed(1);

    console.log(`âœ… ${scenario.name}`);
    console.log(`   Bundle: ${size.gzipped} bytes gzipped`);
    console.log(`   Tree-shaking: ${efficiency}% unused code eliminated`);
    console.log('');
  }
}

analyzeTreeShaking().catch(console.error);
```

- [ ] **Add to package.json**
```json
{
  "scripts": {
    "analyze:tree-shaking": "node test/measure-tree-shaking.js"
  }
}
```

### Phase 8: Testing and Validation

#### 8.1 Local testing
- [ ] **Run size checks locally**
```bash
npm run size
# All scenarios should pass budgets
```

- [ ] **Generate visualization**
```bash
npm run size:visualize
# Visual report should show bundle composition
```

- [ ] **Test tree-shaking analysis**
```bash
npm run analyze:tree-shaking
# Should show >70% code elimination for Level 1
```

#### 8.2 CI testing
- [ ] **Create test PR** to trigger CI
- [ ] **Verify CI runs bundle size check** (AC#10)
- [ ] **Verify PR comment appears** (AC#11)
- [ ] **Verify artifact upload** (AC#12)
- [ ] **Test CI failure** (intentionally exceed budget)

#### 8.3 Documentation review
- [ ] **Verify README badges display** (AC#14)
- [ ] **Verify BUNDLE_SIZES.md is clear** (AC#15)
- [ ] **Test all npm scripts work**

### Phase 9: Monitoring Setup

#### 9.1 Create bundle size tracking
- [ ] **Add to package.json**
```json
{
  "scripts": {
    "size:track": "npm run size -- --json > .size-limit-report.json"
  }
}
```

#### 9.2 Historical tracking (optional)
- [ ] **Create .github/workflows/track-bundle-size.yml**
```yaml
name: Track Bundle Size History

on:
  push:
    branches: [master, main]

jobs:
  track:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - run: npm ci
      - run: npm run build
      - run: npm run size:track
      - name: Commit size report
        run: |
          git config user.name "Bundle Size Bot"
          git config user.email "bot@usetemporal.com"
          git add .size-limit-report.json
          git commit -m "chore: update bundle size report [skip ci]" || true
          git push || true
```

### Phase 10: Final Validation

- [ ] **Run all size checks** (AC#5-8)
- [ ] **Verify CI integration** (AC#10-12)
- [ ] **Check documentation** (AC#14-15)
- [ ] **Test on sample PR**
- [ ] **Submit for review**

## Technical Notes

### Bundle Size Analysis Tools

**size-limit:**
- Runs actual bundler (Rollup/Webpack)
- Measures real-world sizes
- Enforces budgets with CI
- Supports multiple scenarios

**rollup-plugin-visualizer:**
- Visual treemap of bundle
- Shows what's taking space
- Helps identify optimization opportunities
- Supports multiple formats (treemap, sunburst, network)

**bundlesize:**
- Alternative to size-limit
- GitHub integration
- Simpler configuration

### Why size-limit?

1. **Accurate:** Uses real bundler
2. **Fast:** Parallel execution
3. **Flexible:** Multiple scenarios
4. **CI-ready:** GitHub Actions integration
5. **Developer-friendly:** Clear error messages

### Bundle Size Factors

**What affects bundle size:**
- Number of operations imported
- Adapter choice (native = 0KB, Luxon = 15KB)
- Composables (adds @vue/reactivity)
- Calendar features
- Custom units

**What doesn't affect bundle size:**
- Unused operations (tree-shaken)
- Documentation comments
- Type definitions (.d.ts)

### CI Integration Strategy

**On PR:**
- Run size-limit
- Comment with before/after comparison
- Fail if budget exceeded
- Upload visualization

**On merge:**
- Track historical sizes
- Update README badges
- Generate documentation

### Size Budget Philosophy

**Aggressive budgets force:**
- Careful API design
- Effective tree-shaking
- Minimal dependencies
- Performance-first mindset

**But allow flexibility:**
- Budgets can be adjusted
- Must be justified
- Team discussion required

## Definition of Done

- [ ] Test scenarios created for Level 1, 2, 3 usage
- [ ] size-limit configured with budgets for each level
- [ ] rollup-plugin-visualizer generates bundle reports
- [ ] Tree-shaking effectiveness measured (unused code %)
- [ ] CI workflow runs bundle size checks on PRs
- [ ] PR comments show bundle size comparison
- [ ] Visual reports uploaded as CI artifacts
- [ ] README badges show bundle sizes
- [ ] BUNDLE_SIZES.md documents budgets and rationale
- [ ] All npm scripts (size, size:why, size:visualize) work
- [ ] CI fails when budgets exceeded
- [ ] Tree-shaking validation shows >70% elimination for Level 1

## Risk and Compatibility Check

**Low Risk Assessment:**
- **Primary Risk:** False positives in CI (flaky size measurements)
- **Impact**: LOW - only affects CI pipeline
- **Mitigation**: Use consistent environment, cache dependencies
- **Rollback**: Disable CI checks temporarily

**Compatibility Verification:**
- [ ] No code changes
- [ ] No database changes
- [ ] No UI component changes
- [ ] Performance impact: N/A (build-time only)

## Dev Notes

### Implementation Order

1. **Local setup first**: Install tools, create scenarios
2. **Test locally**: Verify budgets work
3. **Add visualization**: Generate reports
4. **CI integration**: Add workflows
5. **Documentation**: README, BUNDLE_SIZES.md
6. **Validation**: Test on real PR

### Testing Strategy

```bash
# Local development
npm run size                  # Check all budgets
npm run size:why              # See detailed breakdown
npm run size:visualize        # Visual analysis
npm run analyze:tree-shaking  # Effectiveness metrics

# CI testing
# Create test PR
# Intentionally exceed budget to test failure
# Verify PR comment appears
```

### Debugging Tips

**Size check fails:**
```bash
# See detailed breakdown
npm run size:why

# Check what's in the bundle
npm run size:visualize
open dist/stats.html
```

**CI not running:**
```bash
# Check workflow file
cat .github/workflows/bundle-size.yml

# Check CI logs
gh run list --workflow=bundle-size.yml
```

**Budgets too strict:**
```bash
# Measure actual sizes
npm run size -- --json

# Adjust .size-limit.js
# Document reason in PR
```

### Related Stories

- **Story 007.01**: Pure functions (enables tree-shaking)
- **Story 007.02**: Calendar extraction (separate bundle)
- **Story 007.03**: Package exports (enables measurement)
- **Story 007.04**: Builder API (Level 2 measurement)
- **Story 007.05**: Documentation (documents bundle sizes)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation | Claude (BMad Master) |

## Dev Agent Record

_To be filled by development agent upon implementation_

## QA Results

_To be filled by QA reviewer_
