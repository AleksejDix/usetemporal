# Story 007.01: Remove Global Unit Registry and Refactor to Pure Functions

## Status
Proposed

## Epic
007 - Tree-Shaking Architecture Refactor

## Priority
Critical

## Story Points
13

## Story
**As a** developer building a performance-sensitive application,
**I want** the library to use pure functions without global state,
**So that** tree-shaking can eliminate unused code and reduce my bundle size by 76%.

## Story Context

**Existing System Integration:**
- Breaks: Global unit registry pattern, side-effect imports
- Refactors: All operations (period, divide, merge, next, previous, go, split, contains, isSame)
- Technology: TypeScript pure functions, explicit dependency injection
- Follows pattern: Functional programming best practices, zero side effects
- Touch points: 11 operation files, unit-registry.ts, units/definitions.ts, createTemporal.ts, all tests

**Problem Being Solved:**
The current architecture uses a global `unitRegistry` Map that is populated via side-effect imports. This prevents tree-shaking because bundlers cannot determine if the registry's initialization code is needed. Users importing a single operation receive the entire 30KB bundle when they only need 5-7KB.

**Root Cause:**
```typescript
// src/index.ts - Side effect imports
import "./units/definitions";  // ← Executes defineUnit() calls
import "./calendar";            // ← Registers calendar units

// src/unit-registry.ts - Global mutable state
const unitRegistry = new Map<string, UnitDefinition>();

// src/operations/period.ts - Implicit dependency
const unitDefinition = getUnitDefinition(type);  // ← Reads global state
```

## Acceptance Criteria

**Functional Requirements:**
1. Global `unitRegistry` Map is completely removed from codebase
2. `defineUnit()`, `getUnitDefinition()`, and `hasUnit()` functions are removed
3. Unit definitions (year, month, week, etc.) are moved to adapter implementations
4. All operations accept `Adapter` as their first parameter instead of `Temporal`
5. Operations no longer call `getUnitDefinition()` - they use adapter methods directly
6. `src/index.ts` has NO side-effect imports (no `import "./units/definitions"`)

**Breaking Changes (Documented):**
7. Operation signatures change from `(temporal: Temporal, ...)` to `(adapter: Adapter, ...)`
8. Convenience wrapper maintains old API for backward compatibility (separate story)
9. Custom unit registration pattern changes (documented in migration guide)

**Quality Requirements:**
10. All 722 tests pass after refactor with TZ=UTC
11. Test coverage remains ≥87%
12. TypeScript compiles with zero errors
13. No performance regression in operation execution time

**Tree-Shaking Requirements:**
14. Importing only `period` and `divide` results in ≤7KB gzipped bundle
15. Package.json `sideEffects` field is correct (false or specific files)
16. Unused operations result in 0KB in final bundle

## Tasks / Subtasks

### Phase 1: Analysis and Preparation
- [ ] Create feature branch `refactor/tree-shaking-007-01`
- [ ] Tag current state as `v2.0.0-alpha.1-pre-refactor`
- [ ] Document all current operation signatures for reference
- [ ] Run baseline bundle size analysis with rollup-plugin-visualizer
- [ ] Document baseline: test count (722), coverage (87.08%), bundle size (30KB)

### Phase 2: Adapter Enhancement
- [ ] **Update Adapter interface** to include unit definitions (AC#3)
  - Add optional `getUnitDefinition(unit: AdapterUnit)` method
  - Or keep minimal - adapters already have startOf/endOf which handle units
- [ ] **Review all adapter implementations** (native, date-fns, luxon, temporal)
  - Verify they handle all AdapterUnit types correctly
  - Ensure no dependencies on global registry
- [ ] **Run adapter tests** to establish pre-refactor baseline

### Phase 3: Remove Global Registry
- [ ] **Delete or gut unit-registry.ts** (AC#1, #2)
  - Remove `unitRegistry` Map
  - Remove `defineUnit()`, `getUnitDefinition()`, `hasUnit()`, `clearUnitRegistry()`
  - Keep file if exporting types, otherwise delete
- [ ] **Delete units/definitions.ts** (AC#3, #6)
  - Remove all `defineUnit()` calls for built-in units
  - Unit logic moves to adapters (they already handle startOf/endOf)
- [ ] **Update src/index.ts** (AC#6)
  - Remove `import "./units/definitions";`
  - Remove any other side-effect imports
- [ ] **Update types.ts** if needed
  - Remove `UnitDefinition` interface if no longer used
  - Keep `Unit` type (string union)

### Phase 4: Refactor Operations (CRITICAL)

#### 4.1 Update operation signatures (AC#4, #7)
- [ ] **period.ts**: Change `(temporal: Temporal, ...)` → `(adapter: Adapter, ...)`
  - Remove `getUnitDefinition()` call
  - Use `adapter.startOf()` and `adapter.endOf()` directly
  - Update JSDoc comments
  - Handle custom periods separately (no adapter needed)
- [ ] **divide.ts**: Change signature to accept `adapter` first
  - Remove registry lookups for division validation
  - Use adapter methods for period calculations
- [ ] **merge.ts**: Change signature to accept `adapter` first
  - Remove any registry dependencies
- [ ] **next.ts**: Change signature to accept `adapter` first
- [ ] **previous.ts**: Change signature to accept `adapter` first
- [ ] **go.ts**: Change signature to accept `adapter` first
- [ ] **split.ts**: Verify - likely already pure
- [ ] **contains.ts**: Verify - likely already pure (just date comparisons)
- [ ] **isSame.ts**: Change signature if needed
- [ ] **utils.ts** (isToday, isWeekday, isWeekend): Change signatures if needed

#### 4.2 Update internal operation calls
- [ ] **Search codebase** for all operation imports and calls
- [ ] **Update operations that call other operations** (e.g., merge calls period)
  - Pass adapter explicitly
- [ ] **Update createTemporal.ts** (will be addressed in later story for builder API)
- [ ] **Update usePeriods.ts composable** (will be addressed in later story)

### Phase 5: Update Tests

#### 5.1 Unit tests
- [ ] **Update all .test.ts files** in operations/ (AC#10)
  - Change operation calls from `operation(temporal, ...)` to `operation(adapter, ...)`
  - Extract `adapter` from `temporal.adapter` in test setup
  - Update expected function signatures in type tests

#### 5.2 Multi-adapter tests
- [ ] **Update all .multi-adapter.test.ts files** (AC#10)
  - Pass adapter directly to operations
  - Ensure all 4 adapters tested (native, date-fns, luxon, temporal)

#### 5.3 Integration tests
- [ ] **Update __tests__/integration/*.test.ts** (AC#10)
  - Refactor to use new operation signatures
  - Verify cross-operation interactions still work

#### 5.4 Test validation
- [ ] Run `TZ=UTC npm test` - all 722 tests must pass (AC#10)
- [ ] Run `npm run test:coverage` - verify ≥87% coverage (AC#11)
- [ ] Run `npm run type-check` - zero TypeScript errors (AC#12)

### Phase 6: Validation and Documentation

- [ ] **Run bundle size analysis** (AC#14, #16)
  ```bash
  # Create test file that imports only period + divide
  echo 'import { period, divide } from "@allystudio/usetemporal/operations"; export { period, divide }' > test-minimal.js
  npx rollup test-minimal.js --format esm -o dist/test-minimal.js
  gzip -c dist/test-minimal.js | wc -c  # Should be ≤7KB
  ```
- [ ] **Verify unused operations are excluded**
  - Import only `period`, check bundle doesn't include `merge` code
- [ ] **Performance benchmarking** (AC#13)
  - Benchmark operation execution times before/after
  - Ensure no regression (should be same or faster)
- [ ] **Update package.json** (AC#15)
  - Set `"sideEffects": false` (verify this is now correct)
- [ ] **Document breaking changes** in CHANGELOG.md
- [ ] **Create migration notes** for Story 007.05 (documentation story)

### Phase 7: Code Review and QA
- [ ] Self-review all changes
- [ ] Run full test suite one final time
- [ ] Check for any missed registry references: `git grep -i "unitRegistry"`
- [ ] Check for any missed defineUnit calls: `git grep -i "defineUnit"`
- [ ] Verify no orphaned imports
- [ ] Submit for QA review

## Technical Notes

### Current vs. New Architecture

**Before (Global Registry):**
```typescript
// Side effect on import
import "./units/definitions";  // ← Executes defineUnit() calls

// Global state
const unitRegistry = new Map<string, UnitDefinition>();

// Operation uses global
export function period(temporal: Temporal, date: Date, unit: Unit): Period {
  const unitDef = getUnitDefinition(unit);  // ← Global lookup
  if (unitDef) {
    return unitDef.period(date, temporal.adapter);
  }
  return { start: temporal.adapter.startOf(date, unit), end: ..., type: unit, date };
}

// User code (30KB bundle)
import { period } from '@allystudio/usetemporal';
```

**After (Pure Functions):**
```typescript
// NO side effects

// Operation is pure
export function period(adapter: Adapter, date: Date, unit: Unit): Period {
  // No registry lookup - adapters handle all units
  const start = adapter.startOf(date, unit);
  const end = adapter.endOf(date, unit);
  return { start, end, type: unit, date };
}

// User code (5-7KB bundle, only what's imported)
import { period } from '@allystudio/usetemporal/operations';
import { createNativeAdapter } from '@allystudio/usetemporal/native';

const adapter = createNativeAdapter();
const month = period(adapter, new Date(), 'month');
```

### Adapter Capabilities

Adapters already support all built-in units via `startOf` and `endOf`:
- year, quarter, month, week, day, hour, minute, second

The adapter interface already provides everything needed:
```typescript
interface Adapter {
  startOf(date: Date, unit: AdapterUnit): Date;
  endOf(date: Date, unit: AdapterUnit): Date;
  add(date: Date, value: number, unit: AdapterUnit): Date;
  diff(start: Date, end: Date, unit: AdapterUnit): number;
}
```

**Key Insight**: The unit registry was redundant! Adapters already know how to handle units.

### Migration Path for Custom Units

**Before:**
```typescript
defineUnit('fortnight', {
  period(date: Date, adapter: Adapter) {
    return { start: ..., end: ... };
  }
});
```

**After (Option 1: Custom Adapter):**
```typescript
const myAdapter = {
  ...nativeAdapter,
  startOf(date: Date, unit: AdapterUnit | 'fortnight'): Date {
    if (unit === 'fortnight') return fortnightStart(date);
    return nativeAdapter.startOf(date, unit as AdapterUnit);
  },
  // ... similar for endOf
};
```

**After (Option 2: Helper Function):**
```typescript
function fortnightPeriod(adapter: Adapter, date: Date): Period {
  const start = /* custom logic */;
  const end = /* custom logic */;
  return { start, end, type: 'fortnight' as any, date };
}
```

### Files to Modify (Estimated 25-30 files)

**Core refactor:**
- `src/unit-registry.ts` - DELETE or gut
- `src/units/definitions.ts` - DELETE
- `src/index.ts` - Remove side effects
- `src/operations/period.ts` - Change signature
- `src/operations/divide.ts` - Change signature
- `src/operations/merge.ts` - Change signature
- `src/operations/next.ts` - Change signature
- `src/operations/previous.ts` - Change signature
- `src/operations/go.ts` - Change signature
- `src/operations/isSame.ts` - Change signature
- `src/operations/utils.ts` - Change signatures (isToday, isWeekday, isWeekend)

**Tests (11 operation tests + 9 multi-adapter tests = ~20 test files):**
- All .test.ts and .multi-adapter.test.ts files in operations/
- Integration tests in __tests__/integration/
- Composable tests (reactivity.test.ts)

**Build config:**
- `package.json` - Verify sideEffects setting

### Implementation Strategy

1. **Adapter-first**: Verify adapters handle all units before touching operations
2. **One operation at a time**: Start with `period` (most fundamental), then dependent operations
3. **Test continuously**: Run tests after each operation refactor
4. **Git commits**: Commit after each phase for easy rollback

### Risk Mitigation

**Risk**: Tests fail after signature changes
- **Mitigation**: Fix one operation at a time, test incrementally

**Risk**: Performance degrades without registry caching
- **Mitigation**: Adapters already cache internally, benchmark to verify

**Risk**: Custom unit users have no migration path
- **Mitigation**: Document two alternative approaches (custom adapter or helper functions)

**Risk**: Bundle size target not met
- **Mitigation**: Validate early in Phase 6, adjust exports strategy if needed

## Definition of Done

- [ ] Global `unitRegistry` removed from codebase
- [ ] All operations use pure function signatures with adapter parameter
- [ ] All 722 tests pass with `TZ=UTC npm test`
- [ ] Code coverage ≥87%
- [ ] TypeScript compiles with zero errors
- [ ] Bundle size for minimal usage ≤7KB gzipped (period + divide + native adapter)
- [ ] Unused operations result in 0KB in bundle
- [ ] No side-effect imports in src/index.ts
- [ ] Performance benchmarks show no regression
- [ ] Breaking changes documented in CHANGELOG.md
- [ ] Migration notes created for documentation story

## Risk and Compatibility Check

**High Risk Assessment - Breaking Changes:**
- **Primary Risk**: This is a breaking change to all operation APIs
- **Impact**: HIGH - affects all users of the library
- **Mitigation**: Package is v2.0.0-alpha.1 and NOT published to npm - perfect timing
- **Rollback**: Git branch allows full rollback if needed

**Compatibility Verification:**
- [x] Breaking changes to public API - **DOCUMENTED AND ACCEPTED FOR v2.0**
- [ ] No database changes
- [ ] No UI component changes
- [ ] Performance impact: POSITIVE (faster tree-shaking, potentially faster operations)

## Dev Notes

### Implementation Order

1. **Start with adapters**: Ensure they're ready
2. **Delete registry first**: Force compilation errors to find all usages
3. **Fix period() first**: Most fundamental operation
4. **Fix operations in dependency order**:
   - period (foundation)
   - divide (depends on period indirectly)
   - merge (calls period)
   - next/previous/go (call period)
   - split (may call period)
   - contains (pure, no registry)
   - isSame (may use period)
   - utils (likely call period)
5. **Fix tests**: Update as operations are fixed
6. **Validate**: Bundle size and performance

### Debugging Tips

**Finding all registry usages:**
```bash
git grep "getUnitDefinition"
git grep "defineUnit"
git grep "unitRegistry"
git grep "from.*unit-registry"
```

**Verifying tree-shaking:**
```bash
# Build a minimal test
echo 'import { period } from "./src/operations/period"; export { period }' > test.js
npx rollup test.js --format esm -o dist/test.js
npx rollup-plugin-visualizer dist/test.js

# Check what's included
cat dist/test.js  # Should NOT contain merge, divide, etc.
```

**Performance testing:**
```typescript
// benchmark.ts
const adapter = createNativeAdapter();
const iterations = 100000;

console.time('period');
for (let i = 0; i < iterations; i++) {
  period(adapter, new Date(), 'month');
}
console.timeEnd('period');
```

### TypeScript Challenges

**Challenge**: Changing function signatures breaks everywhere
- **Solution**: Use TypeScript's "Find All References" to track all call sites

**Challenge**: Tests use `temporal.adapter` pattern
- **Solution**: Extract adapter in test setup: `const { adapter } = temporal;`

**Challenge**: Temporal interface still needed for other features
- **Solution**: Keep Temporal interface, but operations use Adapter directly

### Related Stories

- **Story 007.02**: Extract calendar units (depends on this)
- **Story 007.03**: Update package exports (depends on this)
- **Story 007.04**: Create builder API convenience layer (compensates for breaking changes)
- **Story 007.05**: Documentation and migration guide (documents breaking changes)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation with full brownfield context | Claude (BMad Master) |

## Dev Agent Record

_To be filled by development agent upon implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

## QA Results

_To be filled by QA reviewer_

### Review Date
_TBD_

### Reviewed By
_TBD_

### Code Quality Assessment
_TBD_

### Compliance Check
_TBD_

### Security Review
_TBD_

### Performance Considerations
_TBD_
