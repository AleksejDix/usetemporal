# Story 011.10: Bundle Size Analysis and Optimization

## Status

Draft

## Story

**As a** developer concerned about bundle size,
**I want** comprehensive bundle size analysis and optimization,
**so that** I can verify the framework-agnostic refactor achieves bundle size reduction goals.

## Acceptance Criteria

1. Core package bundle size ≤8KB gzipped
2. Vue package bundle size ≤22KB gzipped (including core)
3. React package bundle size ≤20KB gzipped (including core)
4. Tree-shaking effectiveness score ≥9/10
5. Bundle size analysis report generated for all packages
6. Comparison report vs alpha.1 baseline created
7. CI/CD bundle size monitoring configured
8. Bundle size badges added to README files
9. Optimization recommendations documented
10. Bundle visualization tools configured
11. Size regression alerts configured
12. Documentation updated with bundle size information

## Tasks / Subtasks

- [ ] Measure baseline sizes (AC: 1, 2, 3)
  - [ ] Build all packages: `npm run build`
  - [ ] Measure core package gzipped size
  - [ ] Measure Vue package gzipped size
  - [ ] Measure React package gzipped size
  - [ ] Record alpha.1 baseline for comparison
  - [ ] Document methodology

- [ ] Analyze bundle composition (AC: 5)
  - [ ] Install bundler analysis tools (rollup-plugin-visualizer)
  - [ ] Generate bundle visualization for core
  - [ ] Generate bundle visualization for Vue
  - [ ] Generate bundle visualization for React
  - [ ] Identify largest dependencies
  - [ ] Document findings

- [ ] Test tree-shaking (AC: 4)
  - [ ] Create minimal test app importing single operation
  - [ ] Build and measure bundle size
  - [ ] Verify unused code eliminated
  - [ ] Test multiple import scenarios
  - [ ] Calculate tree-shaking score
  - [ ] Document results

- [ ] Create comparison report (AC: 6)
  - [ ] Compare core vs alpha.1 core
  - [ ] Document size reduction achieved
  - [ ] Compare Vue package vs alpha.1 full bundle
  - [ ] Show size breakdown by module
  - [ ] Create visual charts/graphs
  - [ ] Save report in `/docs/bundle-analysis/`

- [ ] Optimize if needed (AC: 9)
  - [ ] Review large dependencies
  - [ ] Check for duplicate code
  - [ ] Verify external dependencies properly marked
  - [ ] Optimize imports
  - [ ] Document optimization opportunities
  - [ ] Implement quick wins if any

- [ ] Configure bundle visualization (AC: 10)
  - [ ] Add rollup-plugin-visualizer to all packages
  - [ ] Configure to generate HTML reports
  - [ ] Add npm script: `npm run analyze`
  - [ ] Generate reports in `/dist/stats.html`
  - [ ] Document how to use

- [ ] Set up CI monitoring (AC: 7, 11)
  - [ ] Install bundlesize package
  - [ ] Configure size limits in package.json
  - [ ] Add bundlesize check to CI pipeline
  - [ ] Configure to fail on size regression
  - [ ] Set alert thresholds (+10% = warning, +20% = fail)

- [ ] Create size badges (AC: 8)
  - [ ] Generate bundle size badges
  - [ ] Add to core package README
  - [ ] Add to Vue package README
  - [ ] Add to React package README
  - [ ] Add to main project README

- [ ] Update documentation (AC: 12)
  - [ ] Add bundle size section to main README
  - [ ] Document bundle size by package
  - [ ] Add tree-shaking tips
  - [ ] Link to bundle analysis reports
  - [ ] Explain optimization strategies

- [ ] Validate success criteria
  - [ ] Core ≤8KB ✓
  - [ ] Vue ≤22KB ✓
  - [ ] React ≤20KB ✓
  - [ ] Tree-shaking ≥9/10 ✓
  - [ ] All analysis complete ✓

## Dev Notes

### Bundle Size Measurement

**Measure gzipped size:**
```bash
# Build packages
npm run build

# Measure core
gzip -c packages/usetemporal/dist/index.js | wc -c

# Measure Vue
gzip -c packages/usetemporal-vue/dist/index.js | wc -c

# Measure React
gzip -c packages/usetemporal-react/dist/index.js | wc -c
```

**Expected Results:**
```
Core:  ≤ 8,192 bytes (8KB)
Vue:   ≤ 22,528 bytes (22KB)
React: ≤ 20,480 bytes (20KB)
```

### Bundle Visualization Setup

**Install visualization tools:**
```bash
npm install -D rollup-plugin-visualizer
```

**Configure in vite.config.ts:**
```typescript
import { visualizer } from 'rollup-plugin-visualizer'

export default defineConfig({
  plugins: [
    visualizer({
      filename: 'dist/stats.html',
      gzipSize: true,
      brotliSize: true
    })
  ]
})
```

**Generate visualization:**
```bash
npm run build
# Opens dist/stats.html in browser to view bundle composition
```

### Tree-Shaking Test

**Create test file (test-treeshake.ts):**
```typescript
// Import single operation
import { period } from '@allystudio/usetemporal/operations'
import { createNativeAdapter } from '@allystudio/usetemporal/native'

const adapter = createNativeAdapter()
const month = period(adapter, new Date(), 'month')
console.log(month)
```

**Build with rollup:**
```bash
npx rollup test-treeshake.ts \
  --format esm \
  --file dist/treeshake-test.js

# Measure size
gzip -c dist/treeshake-test.js | wc -c
# Expected: ~5-7KB (only period + dependencies)
```

**Tree-shaking score calculation:**
```
Score = (1 - actualSize / fullBundleSize) * 10

Example:
Single operation: 6KB
Full bundle: 8KB
Score = (1 - 6/8) * 10 = 2.5

Good tree-shaking:
Single operation: 1KB
Full bundle: 8KB
Score = (1 - 1/8) * 10 = 8.75 (≥9 target)
```

### Bundle Size Monitoring

**Configure bundlesize in package.json:**
```json
{
  "bundlesize": [
    {
      "path": "packages/usetemporal/dist/index.js",
      "maxSize": "8 KB",
      "compression": "gzip"
    },
    {
      "path": "packages/usetemporal-vue/dist/index.js",
      "maxSize": "22 KB",
      "compression": "gzip"
    },
    {
      "path": "packages/usetemporal-react/dist/index.js",
      "maxSize": "20 KB",
      "compression": "gzip"
    }
  ]
}
```

**Add to CI pipeline:**
```yaml
# .github/workflows/bundle-size.yml
name: Bundle Size Check

on: [pull_request]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run build
      - run: npx bundlesize
```

### Comparison Report Structure

**Create `/docs/bundle-analysis/v2.0.0-report.md`:**

```markdown
# Bundle Size Analysis Report - v2.0.0

## Executive Summary

- Core package: **X KB** (down from 30KB in alpha.1) - **73% reduction**
- Vue package: **Y KB** (complete framework solution)
- React package: **Z KB** (complete framework solution)

## Detailed Breakdown

### Core Package (@allystudio/usetemporal)

| Module | Size | % of Total |
|--------|------|------------|
| operations | X KB | XX% |
| adapters | X KB | XX% |
| types | X KB | XX% |

### Vue Package (@allystudio/usetemporal-vue)

| Module | Size | % of Total |
|--------|------|------------|
| useTemporal | X KB | XX% |
| usePeriod | X KB | XX% |
| @vue/reactivity | X KB | XX% |
| @allystudio/usetemporal | X KB | XX% |

### Tree-Shaking Effectiveness

- Single operation import: **X KB**
- Two operations: **Y KB**
- Full operations: **Z KB**
- Score: **9.2/10** ✓

## Comparison with alpha.1

| Scenario | alpha.1 | v2.0.0 | Improvement |
|----------|---------|--------|-------------|
| Minimal usage | 30 KB | 8 KB | -73% |
| Vue full | 30 KB | 22 KB | -27% |
| React full | N/A | 20 KB | New |

## Visualizations

[Include bundle composition charts]

## Recommendations

1. [Any optimization opportunities]
2. [Future improvements]
```

### Size Badges

**Generate badges:**
Use https://shields.io or similar:

```markdown
![Core Bundle Size](https://img.shields.io/badge/core-8KB-green)
![Vue Bundle Size](https://img.shields.io/badge/vue-22KB-blue)
![React Bundle Size](https://img.shields.io/badge/react-20KB-blue)
```

### Success Validation

**Automated validation script:**
```bash
#!/bin/bash
set -e

echo "Building packages..."
npm run build

echo "Checking core size..."
CORE_SIZE=$(gzip -c packages/usetemporal/dist/index.js | wc -c)
if [ $CORE_SIZE -gt 8192 ]; then
  echo "❌ Core size $CORE_SIZE exceeds 8KB limit"
  exit 1
fi
echo "✓ Core size: $CORE_SIZE bytes"

echo "Checking Vue size..."
VUE_SIZE=$(gzip -c packages/usetemporal-vue/dist/index.js | wc -c)
if [ $VUE_SIZE -gt 22528 ]; then
  echo "❌ Vue size $VUE_SIZE exceeds 22KB limit"
  exit 1
fi
echo "✓ Vue size: $VUE_SIZE bytes"

echo "Checking React size..."
REACT_SIZE=$(gzip -c packages/usetemporal-react/dist/index.js | wc -c)
if [ $REACT_SIZE -gt 20480 ]; then
  echo "❌ React size $REACT_SIZE exceeds 20KB limit"
  exit 1
fi
echo "✓ React size: $REACT_SIZE bytes"

echo "All bundle size checks passed! ✓"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-24 | 1.0 | Story created from Epic 011 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
