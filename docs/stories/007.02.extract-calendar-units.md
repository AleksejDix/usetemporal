# Story 007.02: Extract Calendar Units to Separate Entry Point

## Status
Proposed

## Epic
007 - Tree-Shaking Architecture Refactor

## Priority
High

## Story Points
8

## Story
**As a** developer who doesn't need calendar functionality,
**I want** calendar units (stableMonth, stableYear) to be an optional import,
**So that** my bundle doesn't include 5-10KB of calendar code I won't use.

## Story Context

**Existing System Integration:**
- Depends on: Story 007.01 (Remove Global Unit Registry) - **MUST be completed first**
- Refactors: Calendar module (stableMonth, stableYear)
- Technology: Separate package export, pure functions
- Follows pattern: Optional feature imports
- Touch points: src/calendar/*, package.json exports, calendar tests, Vue example

**Problem Being Solved:**
Calendar utilities (stableMonth, stableYear) are currently auto-imported via side effects, adding 5-10KB to every bundle even when users don't need calendar features. The stableMonth and stableYear functions use the global unit registry pattern that Story 007.01 removes.

**Current Architecture:**
```typescript
// src/index.ts - Side effect
import "./calendar";  // ← Auto-registers stableMonth, stableYear

// src/calendar/index.ts - Side effects
import "./stableMonth";  // ← Executes defineUnit()
import "./stableYear";   // ← Executes defineUnit()

// src/calendar/stableMonth.ts
defineUnit("stableMonth", { period: ..., divisions: [...] });
```

**Target Architecture:**
```typescript
// src/index.ts - NO calendar import

// User opts in explicitly
import { createStableMonth, createStableYear } from '@allystudio/usetemporal/calendar';

// Calendar functions are pure
const stableMonth = createStableMonth(adapter, new Date(), weekStartsOn);
```

## Acceptance Criteria

**Functional Requirements:**
1. Remove `import "./calendar"` from src/index.ts
2. Remove `defineUnit()` calls from stableMonth.ts and stableYear.ts
3. Convert stableMonth and stableYear to pure functions accepting adapter
4. Calendar functions signature: `(adapter: Adapter, date: Date, weekStartsOn?: number) => Period`
5. Calendar module exports only helper functions (createStableMonth, createStableYear)

**Package Export Requirements:**
6. Add `@allystudio/usetemporal/calendar` export to package.json
7. Users can import calendar without importing core operations
8. Tree-shaking works: Not importing calendar = 0KB calendar code in bundle

**Quality Requirements:**
9. All calendar tests pass (stableMonth.test.ts, stableYear.test.ts, integration.test.ts)
10. Test coverage for calendar module remains ≥87%
11. TypeScript compiles with zero errors
12. Calendar functionality identical to before refactor

**Documentation Requirements:**
13. Update calendar examples to use new import pattern
14. Document migration from defineUnit to pure functions

## Tasks / Subtasks

### Phase 1: Dependencies and Setup
- [ ] **Verify Story 007.01 is complete** (BLOCKER)
  - Global unit registry removed
  - All operations using pure functions
  - Tests passing
- [ ] Create branch or continue on `refactor/tree-shaking-007-02`
- [ ] Document current calendar bundle size contribution
- [ ] Review calendar test suite to understand coverage

### Phase 2: Refactor stableMonth

#### 2.1 Update stableMonth.ts
- [ ] **Remove defineUnit() call** (AC#2)
  - Delete lines 32-47 (defineUnit block)
  - Remove `import { defineUnit } from "../unit-registry"`
- [ ] **Refactor createStableMonth to pure function** (AC#3, #4)
  - Change signature: `(adapter: Adapter, date: Date, weekStartsOn: number = 1) => Period`
  - Remove dependency on `temporal` parameter
  - Keep getStableMonthBounds helper (already pure)
- [ ] **Remove TypeScript module augmentation** (lines 66-70)
  - No longer needed without unit registry
- [ ] **Update JSDoc comments**
  - Document new function signature
  - Add usage examples with new API

**Before:**
```typescript
defineUnit("stableMonth", {
  period(date: Date, adapter: Adapter) {
    return getStableMonthBounds(date, adapter, 1);
  },
  validate(period) { ... },
  divisions: ["week", "day"],
  mergesTo: "year",
});

export function createStableMonth(temporal: any, date: Date): any {
  const { adapter, weekStartsOn } = temporal;
  // ...
}
```

**After:**
```typescript
/**
 * Create a stable month period - always 42 days (6 weeks)
 * @param adapter - Date adapter instance
 * @param date - Reference date within the month
 * @param weekStartsOn - First day of week (0=Sunday, 1=Monday)
 * @returns Period spanning 6 weeks
 */
export function createStableMonth(
  adapter: Adapter,
  date: Date,
  weekStartsOn: number = 1
): Period {
  const bounds = getStableMonthBounds(date, adapter, weekStartsOn);

  return {
    start: bounds.start,
    end: bounds.end,
    type: "stableMonth" as any,
    date: adapter.startOf(date, "month"),
  };
}
```

### Phase 3: Refactor stableYear

#### 3.1 Update stableYear.ts
- [ ] **Remove defineUnit() call** (AC#2)
  - Delete defineUnit block
  - Remove `import { defineUnit } from "../unit-registry"`
- [ ] **Refactor createStableYear to pure function** (AC#3, #4)
  - Change signature: `(adapter: Adapter, date: Date, weekStartsOn: number = 1) => Period`
  - Remove dependency on `temporal` parameter
- [ ] **Remove TypeScript module augmentation**
- [ ] **Update JSDoc comments**

**Target signature:**
```typescript
export function createStableYear(
  adapter: Adapter,
  date: Date,
  weekStartsOn: number = 1
): Period {
  // Implementation
}
```

### Phase 4: Update Calendar Module

#### 4.1 Update calendar/index.ts (AC#5)
- [ ] **Remove side-effect imports**
  - Remove `import "./stableMonth";`
  - Remove `import "./stableYear";`
- [ ] **Keep re-exports only**
```typescript
/**
 * Calendar-specific utilities
 * Import from '@allystudio/usetemporal/calendar'
 */
export { createStableMonth } from "./stableMonth";
export { createStableYear } from "./stableYear";
```

#### 4.2 Update src/index.ts (AC#1)
- [ ] **Remove calendar side-effect import**
  - Delete `import "./calendar";`
- [ ] **Verify index.ts has NO side-effect imports**

### Phase 5: Update Package Configuration

#### 5.1 Update package.json exports (AC#6, #7)
- [ ] **Add calendar export**
```json
"exports": {
  ".": {
    "types": "./dist/index.d.ts",
    "import": "./dist/index.js"
  },
  "./calendar": {
    "types": "./dist/calendar/index.d.ts",
    "import": "./dist/calendar/index.js"
  },
  "./operations": {
    "types": "./dist/operations/index.d.ts",
    "import": "./dist/operations/index.js"
  },
  // ... existing adapter exports
}
```

#### 5.2 Update TypeScript configuration (if needed)
- [ ] Verify tsconfig.json supports subpath exports
- [ ] Check that build process generates calendar types correctly

### Phase 6: Update Tests

#### 6.1 Update stableMonth.test.ts (AC#9)
- [ ] Change function calls to use new signature
  - Extract `adapter` and `weekStartsOn` from temporal
  - Call `createStableMonth(adapter, date, weekStartsOn)`
- [ ] Verify all test assertions still valid
- [ ] Add tests for new API patterns

**Before:**
```typescript
const temporal = createTemporal({ adapter, weekStartsOn: 1, date: new Date() });
const stable = createStableMonth(temporal, someDate);
```

**After:**
```typescript
const adapter = createNativeAdapter();
const weekStartsOn = 1;
const stable = createStableMonth(adapter, someDate, weekStartsOn);
```

#### 6.2 Update stableYear.test.ts (AC#9)
- [ ] Change function calls to use new signature
- [ ] Verify all test assertions still valid

#### 6.3 Update integration tests (AC#9)
- [ ] Update __tests__/integration/integration.test.ts if it uses calendar
- [ ] Verify calendar integration with other operations

#### 6.4 Run test suite (AC#9, #10)
- [ ] Run `TZ=UTC npm test`
- [ ] All tests must pass
- [ ] Run `npm run test:coverage` - calendar coverage ≥87%

### Phase 7: Update Examples and Documentation

#### 7.1 Update Vue example (AC#13)
- [ ] Find calendar usage in examples/vue
- [ ] Update imports to use `@allystudio/usetemporal/calendar`
- [ ] Update function calls with new signatures
- [ ] Test example runs correctly

**Example: MonthView.vue (if it uses stableMonth)**
```typescript
// Before
import { createTemporal } from '@allystudio/usetemporal';

// After
import { createNativeAdapter } from '@allystudio/usetemporal/native';
import { createStableMonth } from '@allystudio/usetemporal/calendar';

const adapter = createNativeAdapter();
const stable = createStableMonth(adapter, currentDate, 1);
```

#### 7.2 Create migration notes (AC#14)
- [ ] Document defineUnit → pure function migration for calendar
- [ ] Show before/after code examples
- [ ] Save notes for Story 007.05 (documentation story)

### Phase 8: Bundle Size Validation

#### 8.1 Test tree-shaking (AC#8)
- [ ] **Create test file WITHOUT calendar import**
```bash
echo 'import { period } from "@allystudio/usetemporal/operations"; export { period }' > test-no-calendar.js
npm run build
npx rollup test-no-calendar.js --format esm -o dist/test.js
# Check bundle does NOT include stableMonth/stableYear code
cat dist/test.js | grep -i "stable"  # Should return nothing
```

- [ ] **Create test file WITH calendar import**
```bash
echo 'import { createStableMonth } from "@allystudio/usetemporal/calendar"; export { createStableMonth }' > test-calendar.js
npx rollup test-calendar.js --format esm -o dist/test-calendar.js
# Measure calendar code size
gzip -c dist/test-calendar.js | wc -c  # Document size
```

#### 8.2 Document bundle impact
- [ ] Before: Calendar always included (5-10KB)
- [ ] After: Calendar opt-in (0KB if not imported)

### Phase 9: Type Safety and Compilation

- [ ] Run `npm run type-check` - zero TypeScript errors (AC#11)
- [ ] Verify export types work correctly
  - Test importing types: `import type { StableMonth } from '@allystudio/usetemporal/calendar'`
- [ ] Check that IDEs autocomplete new imports correctly
- [ ] Verify JSDoc appears in IDE hover tooltips

### Phase 10: QA and Review
- [ ] Self-review all changes
- [ ] Verify no regression in calendar functionality (AC#12)
- [ ] Check calendar tests cover edge cases (month boundaries, leap years, etc.)
- [ ] Verify examples work end-to-end
- [ ] Submit for QA review

## Technical Notes

### Why Separate Calendar?

**Bundle Size Impact:**
- stableMonth: ~2-3KB (includes week grid logic)
- stableYear: ~2-3KB (includes 52-week grid logic)
- Combined: 5-10KB that many users don't need

**Use Case Split:**
- **Core operations**: Used by 95% of users (period, divide, merge)
- **Calendar utilities**: Used by 20% of users (UI calendar components)

**Tree-Shaking Benefit:**
Non-calendar users save 5-10KB by not importing `@allystudio/usetemporal/calendar`

### Current Calendar Implementation

**stableMonth**: Returns a 42-day (6-week) grid
- Used for consistent calendar month layouts
- Always shows 6 rows of 7 days
- Handles weeks spanning multiple months

**stableYear**: Returns a year with consistent week alignment
- Used for year-view calendars
- Aligns weeks according to weekStartsOn setting

Both use the `defineUnit()` pattern which Story 007.01 removes.

### Refactoring Strategy

**Key Changes:**
1. Remove unit registry dependency
2. Make functions pure (explicit adapter parameter)
3. Separate package export for opt-in usage

**Preserved Features:**
- Same grid calculation logic
- Same 42-day/52-week behavior
- Same integration with divide() operation (users can still divide stable periods)

### Package Export Pattern

```json
// package.json
{
  "exports": {
    "./calendar": "./dist/calendar/index.js"
  }
}
```

This allows:
```typescript
// Tree-shakable - only imports calendar code
import { createStableMonth } from '@allystudio/usetemporal/calendar';

// Does NOT import calendar code
import { period } from '@allystudio/usetemporal/operations';
```

### Migration Path for Users

**Before (auto-imported):**
```typescript
import { createTemporal } from '@allystudio/usetemporal';

const temporal = createTemporal({ adapter, date: new Date() });
const stable = createStableMonth(temporal, date);
```

**After (explicit import):**
```typescript
import { createNativeAdapter } from '@allystudio/usetemporal/native';
import { createStableMonth } from '@allystudio/usetemporal/calendar';

const adapter = createNativeAdapter();
const stable = createStableMonth(adapter, date, 1);
```

**Change Summary:**
- One additional import line
- Pass adapter + weekStartsOn instead of temporal
- Same functionality, better tree-shaking

### Files to Modify (Estimated 8-12 files)

**Core refactor:**
- `src/index.ts` - Remove calendar side effect
- `src/calendar/index.ts` - Remove side-effect imports
- `src/calendar/stableMonth.ts` - Pure function refactor
- `src/calendar/stableYear.ts` - Pure function refactor
- `package.json` - Add calendar export

**Tests:**
- `src/calendar/stableMonth.test.ts` - Update calls
- `src/calendar/stableYear.test.ts` - Update calls
- `src/__tests__/integration/integration.test.ts` - Update if uses calendar

**Examples:**
- `examples/vue/src/components/calendar/*.vue` - Update imports

**Documentation:**
- Migration notes (for Story 007.05)

## Definition of Done

- [ ] Calendar side-effect imports removed from src/index.ts and calendar/index.ts
- [ ] stableMonth and stableYear refactored to pure functions
- [ ] Package.json exports include `./calendar` entry point
- [ ] All calendar tests pass (stableMonth, stableYear, integration)
- [ ] Tree-shaking verified: Not importing calendar = 0KB calendar code
- [ ] Vue example updated and working with new imports
- [ ] TypeScript compiles with zero errors
- [ ] Test coverage ≥87% for calendar module
- [ ] Bundle size reduction documented (5-10KB savings for non-calendar users)
- [ ] Migration notes created for documentation story

## Risk and Compatibility Check

**Medium Risk Assessment - Breaking Changes:**
- **Primary Risk**: Calendar users must update imports and function calls
- **Impact**: MEDIUM - affects only calendar users (~20% of user base)
- **Mitigation**: Clear migration guide, simple API change (add one import)
- **Rollback**: Git branch allows rollback if needed

**Compatibility Verification:**
- [x] Breaking changes to calendar API - **DOCUMENTED AND ACCEPTED FOR v2.0**
- [ ] No database changes
- [ ] No UI component changes
- [ ] Performance impact: POSITIVE (better tree-shaking)

## Dev Notes

### Implementation Order

1. **Complete dependency**: Wait for Story 007.01 (remove registry)
2. **Refactor stableMonth first**: Smaller, simpler than stableYear
3. **Test immediately**: Run tests after each file change
4. **Update stableYear second**: Apply lessons from stableMonth
5. **Update package.json**: Add export entry
6. **Update tests**: Fix all test files
7. **Update examples**: Verify real-world usage
8. **Validate tree-shaking**: Measure bundle impact

### Testing Strategy

**Unit Tests:**
- Verify grid calculations unchanged
- Test edge cases (month boundaries, leap years)
- Test weekStartsOn parameter variations

**Integration Tests:**
- Verify calendar periods can be divided
- Test calendar with different adapters
- Verify compatibility with core operations

**Bundle Tests:**
- Import only core → verify 0KB calendar code
- Import calendar → measure calendar code size
- Use rollup-plugin-visualizer to visualize

### Debugging Tips

**Finding calendar usages:**
```bash
git grep "createStableMonth"
git grep "createStableYear"
git grep "stableMonth\""
git grep "from.*calendar"
```

**Verifying tree-shaking:**
```bash
# Build without calendar
npm run build
echo 'export { period } from "./dist/operations/period.js"' > test.js
npx rollup test.js --format esm -o dist/test-bundle.js
cat dist/test-bundle.js | grep -i "stable"  # Should be empty

# Build with calendar
echo 'export { createStableMonth } from "./dist/calendar/stableMonth.js"' > test.js
npx rollup test.js --format esm -o dist/test-calendar-bundle.js
ls -lh dist/test-calendar-bundle.js  # Should be ~5-10KB
```

### Related Stories

- **Story 007.01**: Remove Global Unit Registry (dependency - MUST complete first)
- **Story 007.03**: Update Package Exports (related - coordinates export structure)
- **Story 007.04**: Builder API (can use calendar as optional)
- **Story 007.05**: Documentation (documents calendar migration)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation | Claude (BMad Master) |

## Dev Agent Record

_To be filled by development agent upon implementation_

## QA Results

_To be filled by QA reviewer_
